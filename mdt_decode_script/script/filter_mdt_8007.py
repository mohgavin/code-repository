from__future__ import print_function
import os
import sys
import os.path
import shutil
import pandas as pd
from datetime import datetime, timedelta
import zipfile
from dateutil import rrule
import warnings

def combine_mdt(s_date):
	path = '/var/opt/common5/mdt'
	dict_cellname = {}


	path_daily = '/var/opt/common5/mdt/%s' %s_date
	if not os.path.exists(path_daily):
		os.mkdir(path_daily)

	
	list_file = ['mdt_result', 'ue_traffic', 'ue_meas']
	list_file = ['mdt_result']
	dict_columns = {}
	dict_columns['mdt_result'] = ['date', 'site', 'enodebid', 'ci', 'longitude', 'latitude', 'mmes1apid', 'rsrp_serving', 'rsrq_serving', 'CA_capable', 'CA_3CC_capable', 'MIMO4x4', 'ENDC', 'NR_SA']
	dict_columns['mdt_result'] = ['date', 'hour', 'site', 'enodebid', 'ci', 'longitude', 'latitude', 'mmes1apid', 'altitude', 'rsrp_serving', 'rsrq_serving']
	dict_columns['ue_traffic'] = []
	dict_columns['ue_meas'] = []
	dict_columns['result_ue_cap'] = []
	
	#list_site = ['410053','410056','410059','410079','410080','410081','410084','410090','410092','410093','410094','410098','410099','410100','410101','410106','410108','410114','410120','410121','410122','410123','410125','410126','410127','410128','410130','410131','410134','410135','410136','410139','410145','410167','410168','410174','410194','410196','410198','410202','410203','410207','410210','410250','410253','410254','410256','410273','410290','410297','410304','410306','410308','410311','410314','410319','410331','410344','410346','410352','410356','410359','410366','410367','410378','410382','410383','410385','410394','410395','410402','410403','410406','410416','410420','410528','410572','410578','410579','410581','410583','410592','410599','410600','410610','410652','410666','410668','410676','410699','410700','410717','410719','410724','410760','410791','410800','410812','410814','410815','410825','410833','410835','410836','410862','410875','410889','410893','410903','410904','410908','410911','410912','410917','410949','410953','410971','410983','410987','410994','410996','411008','411018','411024','411026','411032','411034','411038','411040','411049','411087','411121','411153','411172','411173','411180','411203','411215','411222','411232','411271','420007','420008','420009','420011','420012','420015','420018','420028','420033','420034','420035','420036','420037','420038','420039','420040','420041','420042','420043','420044','420045','420049','420050','420051','420052','420053','420055','420057','420073','420076','420078','420079','420080','420089','420093','420096','420120','420135','420138','420144','420192','420193','420216','420236','420257','420263','420299','420310','420311','420327','420329','420330','420331','420332','420356','420358','420378','420432','420436','420486','420491','420492','420494','420495','420496','420498','420499','420501','420502','420504','420508','420509','420510','420511','420513','420514','420515','420516','420517','420518','420519','420520','420521','420522','420524','420525','420526','420527','420529','420533','420535','420536','420537','420538','420540','420541','420543','420546','420547','420553','420554','420555','420556','420557','420558','420559','420560','420561','420562','420564','420565','420566','420568','420570','420572','420576','420577','420578','420582','420583','420626','420640','420663','420664','420674','420692','420746','420752','420753','420760','420763','420791','420802','420804','420808','420856','420862','420865','420869','420885','420887','420893','420901','420912','420956','420960','420968','420975','420976','420978','420983','420986','420993','420998','421005','421006','421011','421015','421018','421020','421021','421026','421041','421042','421047','421071','421091','421092','421094','421100','421102','421120','421145','421150','421160','421161','421162','421177','421178','421181','421186','421240','421263','421264','421266','421276','421280','421302','421330','421355','430003','430008','430011','430016','430018','430019','430021','430022','430026','430027','430028','430031','430032','430033','430034','430035','430037','430038','430041','430042','430045','430047','430050','430051','430052','430057','430060','430061','430062','430065','430066','430067','430071','430072','430074','430075','430078','430080','430087','430090','430091','430092','430093','430094','430097','430098','430102','430103','430104','430107','430108','430114','430115','430117','430120','430126','430127','430128','430129','430130','430131','430132','430133','430134','430135','430137','430139','430142','430144','430145','430146','430147','430149','430150','430151','430152','430153','430155','430156','430157','430158','430160','430161','430162','430163','430166','430167','430168','430173','430181','430182','430184','430185','430187','430188','430189','430190','430192','430193','430194','430195','430197','430198','430199','430200','430201','430208','430209','430210','430212','430214','430215','430216','430217','430218','430220','430222','430223','430231','430232','430233','430235','430241','430242','430244','430250','430255','430262','430263','430264','430265','430266','430267','430270','430272','430273','430274','430275','430278','430283','430286','430288','430289','430293','430296','430299','430302','430306','430309','430312','430314','430317','430318','430319','430320','430323','430328','430329','430330','430333','430334','430335','430341','430344','430345','430347','430348','430350','430353','430354','430358','430359','430360','430367','430368','430369','430370','430373','430375','430376','430377','430379','430381','430384','430385','430386','430389','430390','430392','430394','430397','430399','430400','430405','430408','430409','430410','430414','430415','430416','430420','430422','430425','430427','430430','430433','430437','430438','430440','430444','430446','430448','430450','430453','430454','430456','430458','430464','430465','430467','430476','430479','430483','430484','430491','430492','430494','430496','430498','430501','430504','430505','430506','430508','430509','430511','430512','430513','430514','430515','430516','430517','430520','430522','430525','430526','430528','430534','430536','430537','430538','430539','430553','430562','430565','430570','430574','430576','430588','430590','430591','430598','430603','430604','430611','430619','430623','430625','430626','430627','430629','430634','430638','430646','430665','430667','430680','430682','430683','430693','430704','430708','430713','430714','430717','430718','430719','430724','430727','430730','430733','430734','430735','430737','430744','430745','430746','430764','430768','430771','430775','430776','430777','430782','430784','430789','430790','430794','430796','430799','430800','430807','430814','430822','430823','430825','430826','430827','430832','430833','430837','430838','430839','430840','430841','430843','430844','430848','430849','430850','430851','430853','430855','430856','430857','430858','430860','430862','430863','430865','430866','430867','430868','430871','430874','430878','430892','430893','430894','430895','430896','430902','430905','430906','430907','430908','430909','430910','430911','430913','430914','430915','430923','430924','430925','430927','430928','430931','430932','430936','430937','430938','430939','430942','430943','430945','430946','430947','430949','430953','430955','430960','430961','430963','430965','430966','430968','430969','430970','430971','430972','430976','430978','430979','430980','430981','430983','430984','430988','430989','430991','430995','430996','430998','431000','431003','431005','431006','431007','431009','431014','431016','431017','431021','431022','431026','431030','431031','431032','431033','431036','431037','431040','431041','431045','431048','431053','431061','431062','431066','431075','431078','431082','431083','440002','440004','440005','440006','440007','440008','440009','440010','440012','440013','440024','440027','440028','440033','440034','440036','440040','440041','440044','440046','440047','440049','440052','440070','440075','440077','440089','440091','440092','440094','440095','440096','440097','440098','440099','440100','440101','440105','440106','440107','440117','440118','440122','440130','440139','440147','440149','440150','440154','440157','440158','440162','440167','440168','440169','440177','440179','440193','440196','440202','440206','440207','440208','440209','440213','440216','440218','440221','440222','440225','440227','440228','440229','440245','440248','440249','440262','440266','440271','440286','440289','440292','440293','440298','440299','440300','440304','440305','440310','440313','440322','440323','440327','440328','440329','440332','440375','440380','440383','440385','440387','440391','440393','440395','440399','440406','440407','440409','440412','440455','440458','440476','440487','440492','440496','440502','440507','440508','440509','440516','440517','440518','440519','440526','440529','440546','440558','440565','440566','440577','440582','440587','440604','440612','440613','440620','440621','440623','440628','440630','440631','440638','440640','440644','440648','440656','440657','440658','440661','440671','440677','440678','440687','440691','440696','440702','440703','440705','440709','440712','440713','440715','440721','440726','440731','440737','440742','440748','440749','440750','440751','440752','440754','440755','440759','440762','440763','440765','440767','440778','440791','440797','440798','440811','440812','440813','440833','440838','440845','440849','440850','440852','440857','440869','440885','440893','440899','440936','451458','460050','460088','460157','460294','470447','470460','470497']
	list_site = [530046,530927,530115,532955,530081,530669,530774,530779,530448,530078,530238,530898,530906,521322,530614,530903,530786,530780,533160,530899,530869,530301,530039,532426,530040,532468,530105,532146,531996,530053,530054,530309,530107,530633,532743,530634,530568,530564,530013,531992,530037,530063,530084,530064,531962,530043,530912,530539,531017,530300,530316,530639,531145,530166,530086,530240,530048,531036,532274,530335,532372,530341,530188,530034,532465,530036,532863,530354,530750,532905,530800,530509,532747,530370,530372,530909,531163,530384,530386,531106,531912,532908,531396,530376,531519,531986,531384,530857,532201,531720,531678,530242,530089,530091,530092,530245,532469,530207,531299,531229,530338,530211,530337,530224,530811,531102,530804,532458,530508,531252,532506,530864,530944,531679,531351,531353,530246,530185,530103,530215,530217,530218,531389,530952,531354,531253,531355,532391,530512,531126,531356,531357,531358,532693,531826,531248,532700,531414,531405,533128,531360,530808,531093,532660,531407,531410,533159,531094,532696,531095,531171,531390,531203,532222,530279,531725,531708,531379,532002,532744,532318,531759,531176,531309,531766,531767,531768,531769,531737,531823,531771,532176,531804,531821,531836,531755,531745,533107,531835,531994,531728,532804,531729,531840,531747,531837,531756,531853,531732,531857,531833,533155,531731,531752,531942,531889,532035,532424,532403,530500,530050,530326,532081,530397,530551,530468,532373,530286,532874,530552,532160,531703,531020,530560,530707,530656,530044,530066,530359,530067,530571,530052,531925,530323,530290,530388,532464,530022,530057,530059,530060,530061,530411,531693,531027,530068,530585,531235,530611,530530,530790,530759,530346,530076,532059,530093,530094,530924,530765,530125,531037,532913,530776,532231,530805,532883,531097,530444,530151,530155,532008,532145,532135,530391,532214,531943,531344,530162,530668,530079,532757,531951,530027,532445,530080,530305,530226,532857,530236,532295,530116,530028,532061,530671,531328,533151,530351,530791,532987,530674,530192,530017,530165,532442,530083,530194,532712,530195,532004,530367,531665,532142,530901,532792,530449,533127,533080,531347,531348,533109,530479,530672,532970,530673,533113,533173,530675,530777,533117,531247,532775,530783,533046,532508,533174,530775,531307,530782,533114,532980,530781,532995,530925,530789,533106,532981,530794,533120,530793,532299,530464,531391,533040,530307,533175,530796,531413,532688,530047,530001,532439,530029,532723,530005,532843,530006,532809,530299,531926,530328,530055,532763,532060,530008,530056,532162,530322,530152,532819,530718,533076,532962,530536,532314,530510,530647,533014,530062,532455,530009,532789,532296,530010,532475,530011,532753,530012,532842,530020,532476,530042,532453,530014,530361,530065,532715,530276,531016,532958,530652,530820,533027,532993,530529,533172,530511,532972,531018,530306,532232,530126,532197,530347,530277,530085,530442,530033,530368,532689,530087,532275,530088,532450,530167,532886,530302,532431,531086,533101,530168,530111,530318,530069,530070,531953,530071,532824,530072,532434,530344,530298,532216,530339,532446,530196,530450,532695,530015,532451,530073,530320,530355,532151,530225,530918,532800,530919,532882,530241,530314,530035,530451,532141,530038,530074,530321,532990,530456,530507,532876,533097,530499,530104,530118,532999,530950,531721,533001,530941,530948,532462,531714,532471,531672,532918,531381,531382,531383,531455,531987,530373,532402,530374,532756,530375,532003,531716,532435,530377,531717,531718,532433,531694,531696,531701,531426,530937,531520,531539,530380,531719,532820,531236,532749,530249,530201,530182,530169,532466,530202,530203,530204,530243,530205,530170,530206,532718,530030,532724,530171,530220,532682,530248,530219,530255,530244,530228,530253,530250,530187,531947,532750,530227,530247,530031,532716,530252,530304,532456,530208,530181,532181,530256,530209,532767,530210,530447,532711,530230,530191,530153,532721,531230,530222,530183,530223,530178,531114,530254,530231,530806,530803,533105,531349,533118,532509,531350,533009,531189,532912,530229,532737,530381,531385,531697,531698,531699,530498,533100,532507,531292,533000,531403,533079,531352,532858,531380,530807,530212,532719,532690,530213,530365,530179,530214,531231,532438,531240,531237,530345,532720,531232,532662,530278,531386,533130,531387,531388,532107,531151,531702,530455,532879,533171,530816,531345,530814,533102,530815,532807,531254,533099,531121,533044,532501,530817,532976,531293,533110,532225,531359,532801,531392,533056,530818,532802,531404,530819,533116,532964,531088,531249,531190,531418,531196,532368,532878,531089,531255,530809,532692,531091,531406,531092,533115,531294,530813,533111,530678,533153,531361,533119,531250,532877,531261,533152,531409,531412,530177,531417,530184,531238,531712,531374,531074,532752,531067,531394,532947,531049,532118,531122,531724,531419,532946,531670,532835,531710,533198,531411,531234,532994,531257,531204,531420,531295,531415,531371,531364,531395,532948,531377,531367,531378,531393,531369,531706,531366,531375,531711,531372,531368,531705,532481,531681,531373,533006,531376,531704,532751,531370,531365,532785,531707,532691,531993,532019,533071,532082,531982,531206,531930,531760,531175,531258,531761,531167,532950,531762,531207,532992,531763,533039,531931,532954,531909,532971,531208,531209,532917,531932,531764,532911,531765,531140,532952,532969,531141,531310,531736,531956,531327,531832,532292,531738,531770,532951,533208,531916,532961,531933,531825,531820,531856,531812,531806,531845,531839,531757,532953,531735,531749,531733,531990,531746,531941,532725,531849,532960,531734,531848,533185,531888,533154,531928,532748,531876,531750,531846,531751,533054,531897,531858,532079,532495,533050,531753,531841,531842,532513,532011,531850,531754,531847,531748,532025,532966,532121,532477,532046,532053,532967,532122,532080,532156,522928,532119,532115,532120,532043,532094,532810,532038,532049,532113,532037,532026,532193,532350,532493,532897,532422,532330,533122,532388,532270,532230,532355,532352,532347,532862,532361,532356,532698,532366,532830,532354,532247,532423,532286,532382,532255,532323,532335,532248,532406,532893,532344,533108,532336,532726,532269,532346,532282,532895,532259,532291,532739,532249,532669,532674,532887,532317,532358,533168,532902,532812,532889,532334,532370,532390,532384,532378,532705,532899,532516,532517,532518,532519,532533,532553,532554,532562,532563,532580,532581,532582,532583,532615,532616,532617,532630,532631,532632,532633,532634,532635,533166,533167,532975,530506,530640,533053,530003,532713,530356,532852,530284,532436,530549,533156,530308,530343,532991,530460,530573,530452,530108,532183,530760,533052,530784,532872,530342,533058,530654,533077,531019,530558,533059,530559,530911,532708,530651,530706,530457,532989,530655,530657,530333,532722,530575,533061,530648,533062,530349,532449,530645,530646,530649,533028,531416,532959,530101,530288,530289,532412,530350,530352,530127,530410,530041,530058,532227,532443,530330,530334,532224,530332,532734,530293,531034,530294,530295,532982,531028,530913,530895,532833,532963,530497,530905,530505,530914,533017,530733,533016,530584,533112,532796,532697,530736,530737,532429,530075,530746,532986,533183,532795,530742,533065,530686,533012,530917,533011,533002,530916,530470,531033,531006,530189,530340,530348,530331,531013,530754,531014,533010,531007,530921,533013,530471,533048,530495,533066,530922,532502,532956,531010,530761,532463,530102,530364,532452,530363,532440,530329,532448,530472,533043,532806,531040,533022,532984,530764,531041,531042,530458,533051,530797,531043,533015,530766,530753,530752,533121,531098,530336,532714,530016,533170,530141,530147,530163,530445,530154,530160,530143,530173,530446,530099,530100,530145,531246,531244,532110,532149,532148,530159,532341,530157,530161,530148,530175,532338,530158,530437,530438,532798,532242,532266,532209,532328,532134,532371,532511,532360,532670,532383,532400,532357,532909,532191,532213,531245,532158,530174,532353,530149,530156,530142,530144,530146,532865,530190,530117,532717,530199,532467,530018,530193,530164,530197,530200,530362,530095,530096,530232,530233,530186,530234,531674,530274,532277,530272,531677,530271,531813,532427,531816,531700,532054,531671,531673,530315,532205,531015,530382,530303,531695,531669,531066,530106,532772,530357,530319,532770,530324,532430,532284,532484,531110,531666,532289,531233,531819,530439,530237,531818,530287,532073,530353,532164,532398,532421,531814,530358,530273,530311,530313,530283,530296,530281,530280,530275,530251,530282,530239,530292,530312,532659,530409,530407,532668,530440,530310]
	#list_site = ['4424974E', '4424739E', '441PX427E_CO', '441PL390E_CO', '441PL065E_CO', 'MC4431290E', 'SH3421104G_CO', '5018G_CO', '4424949E_CO', '441PC957E', '441PC430E_CO', '4410786E_CO', '441PX077E', '441PX087E', '441PL026E_CO', '4424902E', '442PL658E', '4424933E', '4425013E', '441PC256E_CO', '4425498E_BB', '4425007E_CO', 'V061G_CO', '441PL503E_CO', '441PC164E', 'SH4431545E', '341PC995G_CO', '442PC019E', '441PL074E_CO', '441PC902E', '441PL609E_CO', '341PX400G_CO', '5022G_CO', '442PX4803E', '441PX371E', '441PX910E_CO', '442PC087E', '441PL060E_CO', '441PL461E', '441PC199E_CO', '441PL384E_CO', '4424974E_BB', '441PX078E', '441PX094E_CO', 'MC4424718E', '4433055E', '341SC996G_CO', '441PX323E', '441PC960E_CO', '442PC009E_CO', '5016G_CO', '441PX364E_CO', '442PX349E_CO', '441PC439E', '442PC032E', '5015G_CO', '442PC472E', '4433058E', '5022G_C2', '441PC498E_CO', '442PC225E', '441PC173E', '3412390G_CO', '441PC402E', '5265G_CO', '441PC083E', 'SH4412317E_CO', '442PC179E', '4435480E', '3412296G_CO', '441A088E_CO', '441PC039E', '341PC251G_CO', '441PC124E', 'MC4415798E', '441PC805E', '442PC079E', '441PX029E']


	for file_type in list_file:
		list_df = []
		for hour in range(24):
			hour = '%02d'%hour
			ta_path = '%s/%s'%(path_daily, hour)
			#print("   Checking %s"%ta_path)
			if os.path.exists(ta_path):
				for file in os.listdir(ta_path):
					if file_type in file:
						if file_type != 'result_ue_cap':
							if file.endswith('.csv'):
								zip_file = '%s/%s.zip'%(ta_path, file_type)
								zf = zipfile.ZipFile(zip_file, "w", zipfile.ZIP_DEFLATED)
								zf.write('%s/%s'%(ta_path, file), '%s.csv'%file_type)
								zf.close()
								os.remove('%s/%s'%(ta_path, file))
								file = '%s.zip'%file_type
							
						#print("    reading %s %s %s %s on %s"%(file_type, enm, s_date, hour, datetime.now()))
						if len(dict_columns[file_type]) == 0:
							df_new = pd.read_csv('%s/%s'%(ta_path,file), delimiter=",", index_col=None, header='infer')
							df_new = df_new.loc[df_new['enodebid'].isin(list_site)]
							#df_new = df_new.loc[df_new['site'].isin(list_site)]
							if len(df_new) > 0:
								print('   Found %s data for MDT'%len(df_new))
								list_df.append(df_new)
						else:
							df_new = pd.read_csv('%s/%s'%(ta_path,file), delimiter=",", index_col=None, header='infer', usecols=dict_columns[file_type])
							df_new = df_new.loc[df_new['enodebid'].isin(list_site)]
							#df_new = df_new.loc[df_new['site'].isin(list_site)]
							if len(df_new) > 0:
								print('   Found %s data for MDT'%len(df_new))
								list_df.append(df_new)
		if len(list_df) > 0:
			df = pd.concat(list_df, axis=0)
			df.to_csv('%s/filter_%s.csv'%(path_daily, file_type), index=None)
			zip_file = '%s/filter_%s.zip'%(path_daily, file_type)
			zf = zipfile.ZipFile(zip_file, "w", zipfile.ZIP_DEFLATED)
			zf.write('%s/filter_%s.csv'%(path_daily, file_type), 'filter_%s.csv'%(file_type))
			zf.close()
			os.remove('%s/filter_%s.csv'%(path_daily, file_type))
			print('Result on %s/filter_%s.csv'%(path_daily, file_type))
			list_site_collected = df['enodebid'].unique().tolist()
			print('total %s sites found'%len(list_site_collected))

if __name__ == '__main__':
    warnings.filterwarnings('ignore')
    tanggal = datetime.now()
    delta_day = 5
    s_hour_2 = s_hour = 0
    s_date = s_date_2 = ""
    start_datetime = tanggal - timedelta(days=delta_day)
    stop_datetime = start_datetime
    if len(sys.argv) > 1:
        s_date = sys.argv[1]
        if len(sys.argv) >2:
            s_date_2 = sys.argv[2]
        else:
            s_date_2 = s_date

        start_datetime = datetime.strptime(s_date, '%Y%m%d')
        stop_datetime = datetime.strptime(s_date_2, '%Y%m%d')


    python_file_path = os.path.dirname(os.path.realpath(__file__))
    for dt in rrule.rrule(rrule.DAILY, dtstart=start_datetime, until=stop_datetime):
        sekarang = datetime.now()
        s_date = dt.strftime("%Y%m%d")
        print("combining MDT %s" %(s_date))


        combine_mdt(s_date)



    
    

    
    

